## Chapter 6

> 存储器层次结构是可行的，这是因为与下一个更低层次的存储设备相比来说，一个编写良好的程序倾向于更频繁地访问某一个层次上地存储设备。
>
> 如果你的程序需要的数据是存储在 CPU 寄存器中，那么在指令的执行期间，在 0 个周期内就能访问到它们。如果存储在高速缓存中，需要 4~75 个周期。如果存储在主存中，需要上百个周期。而如果存储在磁盘上，需要大约几千万个周期！
>
> 这个思想围绕着计算机程序的一个称为局部性（locality）的基本属性。具有良好局部性的程序倾向于一次又一次地访问相同的数据项集合，或是倾向于访问邻近地数据项集合。
>
> 特别地，我们将注意力集中在高速缓存存储器上，它是作为 CPU 和主存之间的缓存区域，因为它们对应用程序性能的影响最大。你还会学到一种描绘某台机器上存储器层次结构的性能的有趣方法，称为“存储器山（memory mountain）”，它展示出读访问时间是局部性的一个函数。

### 6.1 存储技术

#### 6.1.1 随机访问存储器

> 随机访问存储器（Random-Access Memory，RAM）分为两类：静态的和动态的。静态 RAM（SRAM）比动态RAM（DRAM）更快，但也贵得多。SRAM 用来作为高速缓存存储器，既可以在 CPU 芯片上，也可以在片下。DRAM 用来作为主存以及图形系统的帧缓存区。
>
> 1. 静态 RAM
>
>    SRAM 将每个位存储在一个双稳态的（bistable）存储器单元里。这个电路有这样一个属性，它可以无限期地保持在两个不同的电压配置（configuration）或状态（state）之一。其他任何状态都是不稳定的——从不稳定状态开始，电路会迅速地转移到两个稳定状态中的一个。
>
>    由于 SRAM 存储器单元的双稳态特性，只要有电，它就会永远地保持它地值。
>
> 2. 动态 RAM
>
>    DRAM 将每个位存储为对一个电容的充电。与 SRAM 不同，DRAM 存储器单元对干扰非常敏感。当电容的电压被扰乱之后，它就永远不会恢复了。暴露在光线下会导致电容电压改变。实际上，数码照相机和摄像机中的传感器本质上就是 DRAM 单元的阵列。
>
>    很多原因会导致漏电，使得 DRAM 单元在 10~100 毫秒时间内失去电荷。内存系统必须周期性地读出，然后重写来刷新内存每一位。有些系统也使用纠错码，其中计算机的字会被多编码几个位（例如 64 位的字可能用 72 位来编码），这样一来，电路可以发现并纠正一个字中任何单个的错误位。
>
> 3. 传统的 DRAM
>
>    DRAM 芯片中的单元（位）被分成 d 个超单元（supercell），每个超单元都由 w 个 DRAM 单元组成。一个 d*w 的 DRAM 总共存储了 dw 位信息。
>
>    行地址 i 称为 RAS（Row Access Strobe，行访问选通脉冲）请求。列地址 j 称为 CAS（Column Access Strobe，列访问选通脉冲）请求。
>
>    例如，要从 16*8 的 DRAM 中读出超单元（2，1），内存控制器发送行地址 2。DRAM 的响应是将行 2 的整个内容都复制到一个内部行缓存区。接下来，内存控制器发送列地址 1。DRAM 的响应是从行缓冲区复制出超单元（2，1）中的 8 位，并把它们发送到内存控制器。
>
>    电路设计者将 DRAM 组成成二维阵列而不是线性数组的一个原因是降低芯片上地址引脚的数量。二位阵列组织的缺点是必须分两步发送地址，这增加了访问时间。
>
> 4. 内存模块
>
>    DRAM 芯片封装在内存模块（memory module）中，它插到主板的扩展槽上。Core i7 系统使用的 240 个引脚的双列直插内存模块（Dual Inline Memory Module，DIMM），它以 64 位为块传送数据到内存控制器和从内存控制器传出数据。
>    
>    实例模块用 8 个 64 Mbit 的 8 M*8 的 DRAM 芯片，总共存储 64 MB（兆字节），这 8 个芯片编号为 0~7。每个超单元存储主存的一个字节，而用相应超单元地址为（i，j）的 8 个超单元来表示主存中字节地址 A 处的 64 位字。DRAM 0 存储第一个（低位）字节，DRAM 1 存储下一个字节，依此类推。
>    
> 5. 增强的 DRAM
>
>    - 快页模式 DRAM（Fast Page Mode，FPM DRAM）。传统的 DRAM 将超单元的一整行复制到它的内部行缓冲区中，使用一个，然后丢弃剩余的。FPM DRAM 允许对同一行连续地访问可以直接从行缓冲区得到服务，从而改进了这一点。
>    - 扩展数据输出 DRAM（Extended Data Out DRAM，EDO DRAM）。FPM DRAM 的一个增强的形式，它允许各个 CAS 信号在时间上靠得更紧密一点。
>    - 同步 DRAM（Synchronous DRAM，SDRAM）。就它们与内存控制器通信使用一组显式的控制信号来说，常规的，FPM 和 EDO DRAM 都是异步的。SDRAM 用与驱动内存控制器相同的外部时钟信号的上升沿来代替许多这样的控制信号。最终效果就是 SDRAM 能够比那些异步的存储器更快地输出它地超单元地内容。
>    - 双倍数据速率同步 DRAM（Double Data-Rate Synchronous DRAM，DDR SDRAM）。DDR SDRAM 是对 SDRAM 的一种增强，它通过使用两个时钟沿作为控制信号，从而使 DRAM 的速度翻倍。不同类型的 DDR SDRAM 是用提高有效带宽的很小的预取缓冲区的大小来划分的：DDR（2 位）、DDR2（4 位）和 DDR3（8 位）。
>    - 视频 RAM（Video RAM，VRAM）。它用在图形系统的帧缓冲区中。VRAM 的思想与 FPM DRAM 类似。VRAM 允许对内存并行地读和写。因此，系统可以在写下一次更新地新值（写）的同时，用帧缓冲区中的像素刷屏幕（读）。
>
> 6. 非易失性存储器
>
>    如果断电，DRAM 和 SRAM 会丢失它们的信息，从这个意义上说，它们是易失的（volatile）。另一方面，非易失性存储器（nonvolatile memory）即使是在关电后，依然保存着它们的信息。由于历史原因，虽然 ROM 中有的类型既可以读也可以写，但是它们整体上都被称为只读存储器（Read-Only Memory，ROM）。ROM 是以它们能够被重编程（写）的次数和对它们进行重编程所用的机制来区分的。
>
>    PROM（Programmable ROM，可编程 ROM）只能被编程一次。PROM 的每个存储器单元有一种熔丝（fuse），只能用高电流熔断一次。
>
>    可擦写可编程 ROM（Erasable Programmable ROM，EPROM）有一个透明的石英窗口，允许光到达存储单元。紫外线光照射过窗口，EPROM 单元就被清除为 0。对 EPROM 编程是通过使用一种把 1 写入 EPROM 的特殊设备来完成的。EPROM 能够被擦除和重编程的次数的数量级可以达到 1000 次。电子可擦除 PROM（Electrically Erasable PROM，EEPROM）类似于 EPROM，但是它不需要一个物理上独立的编程设备，因此可以直接在印制电路卡上编程。EEPROM 能够被编程的次数的数量级可以达到 10^5 次。
>
>    闪存（flash memory）是一类非易失性存储器，基于 EEPROM，它已经成为了一种重要的储存技术。我们会仔细研究一种新型的基于闪存的磁盘驱动器，称为固态硬盘（Solid State Disk，SSD），它能提供相对于传统旋转磁盘的一种更快速、更强健和更低能耗的选择。
>
>    存储在 ROM 设备中的程序通常被称为固件（firmware）。当一个计算机系统通电以后，它会运行存储在 ROM 中的固件。
>
> 7. 访问主存
>
>    数据流通过称为总线（bus）的共享电子电路在处理器和 DRAM 主存之间来来回回。每次 CPU 和主存之间的数据传送都是通过一系列步骤来完成的，这些步骤称为总线事务（bus transaction）。读事务（read transaction）从主存传送数据到 CPU。写事务（write transaction）从 CPU 传送数据到主存。
>
>    主要部件是 CPU 芯片、我们将称为 I/O 桥接器（I/O bridge）的芯片组（其中包括内存控制器），以及组成主存的 DRAM 内存模块。这些部件由一对总线连接起来，其中一条总线是系统总线（system bus），他连接 CPU 和 I/O 桥接器，另一条总线是内存总线（memory bus），他连接 I/O 桥接器和主存。I/O 桥接器将系统总线的电子信号翻译成内存总线的电子信号。I/O 桥也将系统总线和内存总线连接到 I/O 总线，像磁盘和图形卡这样的 I/O 设备共享 I/O 总线。

#### 6.1.2 磁盘存储

