## Chapter 5

> 程序优化的第一步是消除不必要的工作，让代码尽可能有效地执行所期望地任务。这包括消除不必要地函数调用、条件测试和内存引用。这些优化不依赖于目标机器地任何具体属性。
>
> 了解了处理器地运作，我们就可以进行程序优化地第二步，利用处理器提供地指令级并行（instruction-level parallelism）能力，同时执行多条指令。
>
> 即时是最好地编译器也受到妨碍优化地因素（optimization blocker）的阻碍，妨碍优化的因素就是程序行为中那些严重依赖于执行环境的方面。
>
> 正如我们会看到的，常常通过确认关键路径（critical path）来决定执行一个循环所需要地时间（或者说，至少是一个时间下界）。所谓关键路径是在循环地反复执行过程中形成地数据相关链。

### 5.1 优化编译器地能力和局限性

> 这种两个指针可能指向同一个内存位置地情况称为内存别名使用（memory aliasing）。
>
> 包含函数调用的代码可以用一个称为内联函数替换（inline substitution，或者简称“内联（inlining）“）的过程进行优化，此时，将函数调用替换为函数体。
>
> GCC 的最近版本会尝试进行这种形式的优化，要么是被命令行选项“-finline”指示时，要么使用优化等级 `-O1` 或者更高的等级时。遗憾的是，GCC 只尝试在单个文件中定义的函数的内联。这就意味着它将无法应用于常见的情况，即一组库函数在一个文件中被定义，却被其他文件内的函数所调用。

实测需要使用 `-O2` 会优化成内联函数。

### 5.2 表示程序性能

> 我们引入度量标准每元素的周期数（Cycles Per Element，CPE），作为一种表示程序性能并指导我们改进代码的方法。
>
> 处理器活动的顺序是由时钟控制的，时钟提供了某个频率的规律信号，通常用千兆赫兹（GHz），即十亿周期每秒来表示。例如，当表明一个系统有“4GHz”处理器，这表示处理器时钟运行频率为每秒 4*10^9 个周期。每个时钟周期的时间是时钟频率的倒数。通常是以纳秒（nanosecond，1 纳秒等于 10^-9 秒）或皮秒（picosecond，1 皮秒等于 10^-12 秒）为单位的。从程序员的角度来看，用时钟周期来表示度量标准要比用纳秒或皮秒来表示有帮助得多。用时钟周期来表示，度量值表示的是执行了多少条指令，而不是时钟运行得有多快。
>
> 这些项中的系数称为每元素的周期数（简称 CPE）的有效值。注意，我们更愿意用每个元素的周期数而不是每次循环的周期数来度量，这是因为像循环展开这样的技术使得我们能够用较少的循环完成计算，而我们最终关心的是，对于给定的向量长度，程序运行的速度如何。我们将精力集中在减小计算的 CPE 上。
>
> 什么是最小二乘拟合
>
> 对于一个数据点（x~1~，y~1~），...，（x~n~，y~n~）的集合，我们常常试图画一条线，它能最接近于这些数据代表的 X-Y 趋势。使用最小二乘拟合，寻找一条形如 y=mx+b 的线，使得下面这个误差度量最小：
> $$
> E(m,b)=\sum\limits_{i=1,n}(mx_i+b-y_i)^2
> $$
> 将 E（m，b） 分别对 m 和 b 求导，把两个导数函数设置为 0，进行推导就能得出计算 m 和 b 的算法。

